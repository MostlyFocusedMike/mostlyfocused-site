<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>How To Use DataLoaders In GraphQL</title>
  <meta property="og:title" content="How To Use DataLoaders In GraphQL" />
  <meta name="description" property="og:description" content="Solve the N+1 problem in GraphQL with dataloaders" />

  <meta property = "article:published_time" content="2024-06-12T23:50:33.137Z" />
  <meta property = "article:modified_time" content="2024-06-12T23:50:33.137Z" />

  <link rel="canonical" href="https://mostlyfocused.com/pages/articles/graphql_dataloader" />
  <meta name="url" property="og:url" content="https://mostlyfocused.com/pages/articles/graphql_dataloader" />
  <meta name="image" property="og:image" content="https://mostlyfocused.com/images/graphql_dataloader/preview.png" />
  <meta property="og:image:secure_url" content="https://mostlyfocused.com/images/graphql_dataloader/preview.png" />
  <meta property="og:image:type" content="image/png" />

  <meta property="article:tag" content="js" />
	<meta property="article:tag" content="graphql" />

  <meta property="level" content="0" />

  <meta property="og:site_name" content="Mostly Focused" />
  <meta property="og:type" content="article" />
  <meta property="article:author" content="Mike Cronin" />
  <meta property="article:section" content="Coding" />
  <meta name="theme-color" content="#252525" />
  <meta name="color-scheme" content="dark">

  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" integrity="sha512-vswe+cgvic/XBoF1OcM/TeJ2FW0OofqAVdCZiEYkd6dwGXthvkSFWOoGGJgS2CW70VK5dQM5Oh+7ne47s74VTg=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
    media="none"
    onload="this.media='all'"
  />
</head>
<body>
<site-heading><header><a id="logo" href="/">mostlyFOCUSED</a></header></site-heading>
<traffic-analyzer></traffic-analyzer>
<main>
<div id="page-scrollers">
  <article-links></article-links>
  <code-jump-buttons></code-jump-buttons>
  <chimp-form side_bar></chimp-form>
</div>
<article>
<hgroup>
  <h1>How To Use DataLoaders In GraphQL</h1>
  <p>Make your GraphQL queries more efficient by batching them</p>
</hgroup>
<hr>
<by-line><p id="by-line">By Mike Cronin</p></by-line>

<svg id="cover" fill="none" viewBox="0 0 1720 965" xmlns="http://www.w3.org/2000/svg">
  <g clip-path="url(#clip0_209_86)"><rect width="1720" height="965" fill="#020617"/><rect x="1603" y="480" width="97" height="97" transform="rotate(-180 1603 480)" fill="#1D334A"/><rect x="1486" y="480" width="98" height="97" transform="rotate(-180 1486 480)" fill="#1D334A"/><rect x="1486" y="361" width="98" height="96" transform="rotate(-180 1486 361)" fill="#1D334A"/><rect x="1603" y="361" width="97" height="96" transform="rotate(-180 1603 361)" fill="#1D334A"/><rect x="1721" y="480" width="98" height="97" transform="rotate(-180 1721 480)" fill="#1D334A"/><rect x="1721" y="361" width="98" height="96" transform="rotate(-180 1721 361)" fill="#1D334A"/><rect x="1371" y="246" width="720" height="250" stroke="#5F5F5F" stroke-width="10"/><rect x="97" y="480" width="98" height="97" transform="rotate(-180 97 480)" fill="#1D334A"/><rect x="97" y="361" width="98" height="96" transform="rotate(-180 97 361)" fill="#1D334A"/><rect x="214" y="480" width="97" height="97" transform="rotate(-180 214 480)" fill="#1D334A"/><rect x="214" y="361" width="97" height="96" transform="rotate(-180 214 361)" fill="#1D334A"/><rect x="332" y="480" width="98" height="97" transform="rotate(-180 332 480)" fill="#1D334A"/><rect x="332" y="362" width="98" height="97" transform="rotate(-180 332 362)" fill="#1D334A"/><rect x="-370" y="246" width="720" height="250" stroke="#5F5F5F" stroke-width="10"/><rect x="749" y="480" width="97" height="97" transform="rotate(-180 749 480)" fill="#1D334A"/><rect x="632" y="480" width="98" height="97" transform="rotate(-180 632 480)" fill="#1D334A"/><rect x="632" y="361" width="98" height="96" transform="rotate(-180 632 361)" fill="#1D334A"/><rect x="749" y="361" width="97" height="96" transform="rotate(-180 749 361)" fill="#1D334A"/><rect x="867" y="480" width="98" height="97" transform="rotate(-180 867 480)" fill="#1D334A"/><rect x="867" y="361" width="98" height="96" transform="rotate(-180 867 361)" fill="#1D334A"/><rect x="984" y="480" width="98" height="97" transform="rotate(-180 984 480)" fill="#1D334A"/><rect x="984" y="361" width="98" height="96" transform="rotate(-180 984 361)" fill="#1D334A"/><rect x="1101" y="480" width="97" height="97" transform="rotate(-180 1101 480)" fill="#1D334A"/><rect x="1101" y="361" width="97" height="96" transform="rotate(-180 1101 361)" fill="#1D334A"/><rect x="1219" y="480" width="98" height="97" transform="rotate(-180 1219 480)" fill="#1D334A"/><rect x="1219" y="362" width="98" height="97" transform="rotate(-180 1219 362)" fill="#1D334A"/><rect x="517" y="246" width="720" height="250" stroke="#5F5F5F" stroke-width="10"/><rect x="749" y="480" width="97" height="97" transform="rotate(-180 749 480)" fill="#1D334A"/><rect x="632" y="480" width="98" height="97" transform="rotate(-180 632 480)" fill="#1D334A"/><rect x="632" y="361" width="98" height="96" transform="rotate(-180 632 361)" fill="#1D334A"/><rect x="749" y="361" width="97" height="96" transform="rotate(-180 749 361)" fill="#1D334A"/><rect x="867" y="480" width="98" height="97" transform="rotate(-180 867 480)" fill="#1D334A"/><rect x="867" y="361" width="98" height="96" transform="rotate(-180 867 361)" fill="#1D334A"/><rect x="984" y="480" width="98" height="97" transform="rotate(-180 984 480)" fill="#1D334A"/><rect x="984" y="361" width="98" height="96" transform="rotate(-180 984 361)" fill="#1D334A"/><rect x="1101" y="480" width="97" height="97" transform="rotate(-180 1101 480)" fill="#1D334A"/><rect x="1101" y="361" width="97" height="96" transform="rotate(-180 1101 361)" fill="#1D334A"/><rect x="1219" y="480" width="98" height="97" transform="rotate(-180 1219 480)" fill="#1D334A"/><rect x="1219" y="362" width="98" height="97" transform="rotate(-180 1219 362)" fill="#1D334A"/><rect x="517" y="246" width="720" height="250" stroke="#5F5F5F" stroke-width="10"/><path d="M1311 371L318 371L318 725L1311 725L1311 559.5" stroke="#FAFAF9" stroke-width="10" stroke-linecap="round"/><path d="M1312 371L1418 248" stroke="#FAFAF9" stroke-width="10" stroke-linecap="round"/><rect x="642" y="694" width="132" height="132" transform="rotate(-180 642 694)" fill="#7DD3FC"/><rect x="483" y="694" width="132" height="132" transform="rotate(-180 483 694)" fill="#7DD3FC"/><rect x="483" y="533" width="132" height="130" transform="rotate(-180 483 533)" fill="#7DD3FC"/><rect x="642" y="533" width="132" height="130" transform="rotate(-180 642 533)" fill="#7DD3FC"/><rect x="801" y="694" width="132" height="132" transform="rotate(-180 801 694)" fill="#7DD3FC"/><rect x="801" y="533" width="132" height="130" transform="rotate(-180 801 533)" fill="#7DD3FC"/><rect x="960" y="694" width="132" height="132" transform="rotate(-180 960 694)" fill="#7DD3FC"/><rect x="960" y="533" width="132" height="130" transform="rotate(-180 960 533)" fill="#7DD3FC"/><rect x="1119" y="694" width="132" height="132" transform="rotate(-180 1119 694)" fill="#7DD3FC"/><rect x="1119" y="533" width="132" height="130" transform="rotate(-180 1119 533)" fill="#7DD3FC"/><rect x="1278" y="694" width="132" height="132" transform="rotate(-180 1278 694)" fill="#7DD3FC"/><rect x="1395" y="532" width="132" height="130" transform="rotate(-180 1395 532)" fill="#7DD3FC"/><rect x="1595" y="532" width="132" height="130" transform="rotate(-180 1595 532)" fill="#7DD3FC"/><rect x="1797" y="533" width="132" height="130" transform="rotate(-180 1797 533)" fill="#7DD3FC"/></g><defs><clipPath id="clip0_209_86"><rect width="1720" height="965" fill="white"/></clipPath></defs>
</svg>

<!-- ARTICLE BODY -->
<div id="article-body">
<p>
  If you're building a GraphQL powered API in Node, you can't do it without <a href="https://www.npmjs.com/package/dataloader" target="_blank" rel="noopener noreferrer">DataLoader</a>. This library lets you batch your queries and keep your API just as efficient as its REST predecessors. In this article we'll just go over the raw mechanics of the library, without getting too bogged down in GraphQL.
</p>
<h2></h2>

<h2>Why do we need DataLoader?</h2>
<p>
  Simply put, DataLoader solves GraphQL's “N+1 problem”. If you don't know what that is, <a href="/pages/articles/n_plus_1_graphql" target="_blank" rel="noopener noreferrer">read this quick explanation</a>. I'm going to assume you understand what that is from this point on, but to recap, it states:
</p>

<blockquote>
  For every 1 database query that returns N results, you will need to make N additional queries
</blockquote>

<p>
  That many queries is inefficient. We would be better off batching those N queries into 1 so instead of N+1 we would always just have 2. This is where DataLoaders come in.
</p>

<h2>DataLoaders: The overview</h2>

<p>At the highest level, a DataLoader:</p>

<ol>
  <li>Collects an array of keys during one tick of the event loop</li>
  <li>Hits the database once with all those keys</li>
  <li>Returns a promise which resolves an array of values</li>
</ol>

<p>
  All you need to make a DataLoader is a batching function that takes in an array of keys, and resolves to an array of values. Both arrays <em>must</em> be the same length, otherwise it will break when it tries to turn them into a key/value store. Let's work with the following DataLoader and fake DB:
</p>

<my-code><!--
const DataLoader = require('dataloader');
const fakeDB = ['Tom', 'Bo', 'Kate', 'Sara', 'Gene', 'Noel'];
const batchGetUserById = async (ids) => {
  console.log(‘called once per tick:', ids);
  return ids.map(id => fakeDB[id — 1]);
};
const userLoader = new DataLoader(batchGetUserById);
-->
</my-code>

<p>
  We have an async function that iterates through a given array of ids and then returns an array of usernames. This is mocking out how a real program would await a result from the DB using an ORM. Remember, since it's async, our function's return value is automatically wrapped in a Promise. We then take the batch function and pass it into a new DataLoader.
</p>

<h2>Using a DataLoader with load()</h2>
<p>
  To actually use a DataLoader, you don't call the batch function. Instead, you use the method <code>load()</code> . That is how your DataLoader can collect all the keys it needs. Each <code>load()</code> saves the key and returns a promise. At the tick of the event loop, it takes all the keys and then passes them into the batch function. The batch function resolves to its values which are then stored with the corresponding keys. Finally, each <code>load()</code>'s promise resolves to the value of its given key.
</p>

<h3>A brief aside on the event loop</h3>
<p>
  I keep mentioning ticks, so we should talk about the event loop. If you have 20-ish minutes, <a href="https://www.youtube.com/watch?v=8aGhZQkoFbQ" target="_blank" rel="noopener noreferrer">watch this video by Phillip Roberts</a>. If not, suffice it to say that each tick of the event loop is what kicks the next resolved async callback into the main callstack.
</p>

<p>
  All you really need to know is that DataLoader is using this event loop ticking process as a way of marking when to fire the batch function. It does this because by that point, all the <code>load()</code> methods will have been fired off for a given query, meaning it knows exactly how many keys to check against the DB.
</p>

<h2>Back to DataLoaders</h2>

<p>
  OK, now look at this example code:
</p>

<my-code><!--
const DataLoader = require('dataloader');

const fakeDB = ['Tom', 'Bo', 'Kate', 'Sara', 'Gene', 'Noel'];

const batchGetUserById = async (ids) => {
  console.log('called once per tick:', ids);
  return ids.map(id => fakeDB[id - 1]);
};

const userLoader = new DataLoader(batchGetUserById);
console.log('\nEvent Loop Tick 1');

userLoader.load(1);
userLoader.load(2).then((user) => {
  console.log('Here is the user: ', user);
});

setTimeout(() => {
  console.log('\nTick 2');
  userLoader.load(3);
  userLoader.load(4);
}, 1000);

setTimeout(() => {
  console.log('\nTick 3');
  userLoader.load(5);
  userLoader.load(6);
}, 2000);
--><pre>Event Loop Tick 1
called once per tick: [ 1, 2 ]
Here is the user:  Bo
Tick 2
called once per tick: [ 3, 4 ]
Tick 3
called once per tick: [ 5, 6 ]</pre>
</my-code>

<p>
  As you can see, our batch function really is only called once per tick. Remember, <code>setTimeout</code> is async, so it kicks us into the next tick every time.
</p>

<p>
  Also notice that even though the batch functions are called with arrays, you can see that <code>load(2)</code> resolves to the proper user of Bo and nothing else. Each <code>load()</code> method will always return the single value. It will likely be a single array in the real world, so lets try for a more realistic example:
</p>


<my-code snip_lang="graphql"><!--
query {
 authors
  books {
   title
  }
 }
}
--><pre></pre>
</my-code>

<p>
  Our loader would be in the <code>books</code> field in this example, and it would find all the books associated with an <code>author_id</code>. Let's use a for loop to simulate 3 different author parent objects with ids 1, 2, and 3:
</p>

<my-code><!--
const DataLoader = require('dataloader');
const fakeBooksDB = [
  { title: 'book 1', author_id: 1 },
  { title: 'book 2', author_id: 2 },
  { title: 'book 3', author_id: 3 },
  { title: 'book 4', author_id: 3 },
];
const batchGetBooksById = async (ids) => {
  const books = ids.map((authorId) => {
    return fakeBooksDB
      .filter(book => book.author_id === authorId);
  });
  console.log('I only get fired once');
  return books;
};
const bookLoader = new DataLoader(batchGetBooksById);
// loop simulates 3 author parent resolvers,
for (let i = 1; i <= 3; i++) {
  bookLoader.load(i).then((res) => {
    console.log(`\nAuthor #${i} books:`);
    console.log(res);
  });
}
--><pre>I only get fired once
Author #1 books:
[ { title: 'book 1', author_id: 1 } ]

Author #2 books:
[ { title: 'book 2', author_id: 2 } ]

Author #3 books:
[ { title: 'book 3', author_id: 3 },
  { title: 'book 4', author_id: 3 } ]</pre>
</my-code>

<p>
  Since this all occurred in the same tick of an event loop, our batch function only fired once. And again, each <code>load()</code> resolved one value, an array with either one or two books.
</p>

<h2>Caching</h2>
<p>
  While the batching is the main focus, DataLoaders also have caching. That means if you ever call <code>load()</code> with the same key twice, it'll look up the value in the DataLoader's key/value store without firing the batch function again:
</p>

<my-code><!--
const DataLoader = require('dataloader');
const fakeDB = ['Tom', 'Bo', 'Kate', 'Sara'];
const batchGetUserById = async (ids) => {
  console.log('I ran!');
  return ids.map(id => fakeDB[id - 1]);
};
const userLoader = new DataLoader(batchGetUserById);
console.log('\nEvent Tick 1');
userLoader.load(1);
userLoader.load(2);

setTimeout(() => {
  console.log('\nEvent Tick 2');
  userLoader.load(2).then((res) => {
    console.log('cached res: ', res);
  });
}, 1000);
--><pre>Event Tick 1
I ran!

Event Tick 2
cached res:  Bo</pre>
</my-code>
<p>The batch function wasn't run, it just looked up the value.</p>

<h2>The loadMany() Method</h2>
<p>
  Sometimes you do want to access more than one key at a time. In those cases, use the <code>loadMany()</code> method:
</p>

<my-code><!--
userLoader.loadMany([3, 4]).then((res) => {
  console.log('Returns an array of values: ', res);
});
--><pre></pre>
</my-code>
<p>
  If you plugged this in to an example above, you'd get <code>Returns an array of values: [ ‘Kate', ‘Sara' ]</code>. Neat right?
</p>

<h2>Load away!</h2>
<p>
  There you have it, the fundamentals DataLoader. There is of course a lot more to this that what's listed here, but with the basics behind you, there are a lot more fun challenges ahead!
</p>

<p>Happy coding everyone,</p>
<p>Mike</p>

<chimp-form></chimp-form>
</div><!-- END ARTICLE BODY -->
</article>
</main>
<latest-articles></latest-articles>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js" integrity="sha512-m3JYEI6gx5fh9jF10FjGoMzVKcV2N6nchcDcqPCdI1L3R2WQV7br2XVNR8iTLb2daOMRl3zldbcfT40xU2ntVw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-graphql.min.js" integrity="sha512-p8unDhIpF714XoC64kGk5Tesd/nr25DYJ33lqIofO8WwHrt/7iXhQyOL9pY8Pr/zpKqDK5gg0axhacrtD8Nadg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script type="module" src="/src/main.js"></script>
</body>
</html>
